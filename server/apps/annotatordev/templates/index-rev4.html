{% extends "base.html" %}

{% block head %}



<script src="static/bower_components/angular/angular.min.js"></script>
<script src="static/bower_components/angular-ui-bootstrap-bower/ui-bootstrap-tpls.min.js"></script>
<script src="static/bower_components/angular-sanitize/angular-sanitize.min.js"></script>
<script src="static/bower_components/angular-xml/angular-xml.min.js"></script>
<script src="static/bower_components/mousetrap/mousetrap.min.js"></script>

<script type="text/javascript" src="static/js/ol-whitespace.js"></script>

<script type="text/javascript" src="static/js/pf-segmentation.js"></script>
<script type="text/javascript" src="static/js/slic-segmentation.js"></script>
<script type="text/javascript" src="static/js/segment-annotator.js"></script>
<script type="text/javascript" src="static/js/dermapp-rev4.js"></script>

<link rel=stylesheet type=text/css href="static/css/ol.css"/>
<link rel=stylesheet type=text/css href="static/css/derm.css"/>

<style>

nav ul ul {
	display: none;
}

nav ul li:hover > ul {
    display: block;
}

nav ul {
	background: #efefef;
	/*background: linear-gradient(top, #efefef 0%, #bbbbbb 100%);*/
	/*background: -moz-linear-gradient(top, #efefef 0%, #bbbbbb 100%);*/
	/*background: -webkit-linear-gradient(top, #efefef 0%,#bbbbbb 100%);*/
	/*box-shadow: 0px 0px 9px rgba(0,0,0,0.15);*/
	/*padding: 0 20px;*/
	/*border-radius: 10px;*/
	list-style: none;
	position: relative;
	display: inline-table;
    padding: 0px !important;
}
	nav ul:after {
		content: ""; clear: both; display: block;
	}

	nav ul li {
		float: left;
	}


    nav ul li:hover {
        background: #4b545f;
        /*background: linear-gradient(top, #4f5964 0%, #5f6975 40%);*/
        /*background: -moz-linear-gradient(top, #4f5964 0%, #5f6975 40%);*/
        /*background: -webkit-linear-gradient(top, #4f5964 0%,#5f6975 40%);*/
    }

    nav ul li:hover a {
        border: 1px solid #f00;
    }

    nav ul li a {
        display: block;
        border: 1px solid #000;
        /*padding: 25px 40px;*/
        /*color: #757575; text-decoration: none;*/
    }

    nav ul ul {
        /*background: #5f6975; */
        /*border-radius: 0px; padding: 0;*/
        position: absolute; top: 100%;
    }
    nav ul ul li {
        float: none;
        /*border-top: 1px solid #6b727c;*/
        /*border-bottom: 1px solid #575f6a; */
        position: relative;
    }
    nav ul ul li a {
        border: 1px solid #555;
        /*padding: 15px 40px;*/
        /*color: #fff;*/
    }
    nav ul ul li a:hover {
        /*background: #4b545f;*/
    }

	nav ul ul ul {
		position: absolute; left: 100%; top:0;
	}
</style>

{% endblock %}

{% block body %}

{% if g.user %}

    <input id="user_email" type="hidden" value="{{ g.user.email }}"/>
    <input id="user_id" type="hidden" value="{{ g.user.id }}"/>




    <div id="angular_id" ng-controller="ApplicationController">
                
            <div ng-controller="AnnotationView" id="viewContainer">



                <div id="map" class="map"></div>

                <div id="annotatorcontainer"></div>

                <div id="toolContainer" ng-controller="AnnotationTool" >



                    <!-- <div class=""> -->
                    <!-- <progress percent="stacked"></progress> -->
                    <!-- </div> -->

                    <!--<div>-->

                        <div class="isichead">
                            <span class="isictitle pull-left">ISIC Annotation Tool</span>
                                <span class="isicuser pull-right">
                                    <a class="btn btn-mini btn-inverse"
                                       href="{{ url_for('logout') }}">
                                        Signed in as {{g.user.email}} (sign out)
                                    </a>
                                </span>
                            <div class="clearfix"></div>
                        </div>

                    <!--</div>-->

{% raw %}


                        <script type="text/ng-template" id="myModalContent.html" class="modalbase">
                            <div class="modal-body">

                                <div>{{base.title}}</div>
                                <div class="btn-group choiceoption" ng-repeat="opt in base.options">
                                    <div class="btn btn-primary"
                                         ng-click="selectOption(opt)">
                                        {{opt.title}}
                                    </div>

                                </div>
                            </div>
                        </script>

                    <div ng-class="showIfStep(-1) ? 'step-header step-active' : 'step-header'" ng-click="gotoStep(-1)">
                        <span>Select image</span><span class="pull-right"><small>{{active_image.Study_num}}</small></span>
                    </div>

                    <div ng-show="showIfStep(-1)">
                        <div class="step-content">
                            <!-- <br><small>(Start index: {{ startingIndex}}</small>) -->

                            <div class="imagePreview">
                                
                                <div class="imagePreviewInner">

                                    <div class='wrapper' ng-repeat="(key, value) in image_list">

                                        <img class="imagethumb" ng-click='selectImage(key)'
                                             src="{{value.thumbnail}}"/>

                                        <div class='description' ng-show="imageHasAnnotations(key)">

                                            <p class='description_content'><i class="fa fa-check"></i></p>

                                        </div>

                                    </div>

                                </div>
                            </div>


                            <div class="lowertoolbar">
                                <div class="btn-group">
                                    <div class="btn" disabled>
                                        You have completed {{completedImages}} of {{totalItems}} in your current task list.
                                    </div>
                                </div>

                                <div class="btn-group pull-right">
                                    <button ng-show="totalSteps"
                                                href="#"
                                                ng-click="nextStep()"
                                                class="btn btn-success">
                                                Begin
                                    </button>

                                </div>

                            </div>

                        </div>


                    </div>


                    <div class="" ng-repeat="(key, value) in decision_tree">

                        <div 
                            ng-click="gotoStep(key)"
                            ng-show="showIfStepGTE(key) || stepHasAnnotations(key)"
                            ng-class="showIfStep(key) ? 'step-header step-active' : 'step-header'"
                            >
                            <span>{{value.title}}</span>
                            <span class="pull-right"
                                  ng-show="stepHasAnnotations(key)">
                                <i class="fa fa-check-square"></i>&nbsp;
                                <a ng-click="deleteSaved(key)"><i class="fa fa-trash-o"></i></a>&nbsp;</span>
                            </div>


                        <div ng-show="showIfStep(key)" class="step-content">






                             <!-- Advanced -->
                             <div class="btn-group"
                                    ng-show="compareState('advanced', tool_bar_state)">

                                <div
                                    ng-click="startMagicWand()"
                                    class="btn btn-primary">
                                        Magic Wand
                                </div>

                                <div
                                    ng-click="startRegionPaint()"
                                    class="btn  btn-primary">
                                        Region Paint
                                </div>

                                <div
                                    ng-click="startPointList()"
                                    class="btn  btn-primary">
                                        Perimeter
                                </div>

                            </div>



                             <!-- magic wand -->
                             
                             <div class="btn-group" 
                                ng-show="compareState('mwdefine', tool_bar_state)">

                                 <div class="btn btn-inverse"
                                      ng-click="clearStep()">
                                     <i class="fa fa-backward"></i></div>

                                <div class="btn btn-primary"
                                      ng-click="increaseParameter()">
                                     <i class="fa fa-chevron-up"></i></div>
                                 <div class="btn btn-primary"
                                      ng-click="decreaseParameter()">
                                     <i class="fa fa-chevron-down"></i></div>

                                 <div class="btn" disabled>Tolerance: <b>{{magicwand_tolerance}}</b></div>


                            </div>




                            <!-- Region paint -->

                            <div class="btn-group" 
                                ng-show="compareState('rpdefine', tool_bar_state)">

                                 <div class="btn"
                                      ng-click="clearStep()">
                                     <i class="fa fa-backward"></i></div>


                                <div class="btn btn-primary"
                                    ng-click="runRegionPaint()">
                                    Start
                                </div>

                                <div class="btn" disabled>
                                   Region paint may take upto 30 sec
                                </div>


                            </div>


                            

                            <div class="btn-group" 
                                ng-show="compareState('rppaint', tool_bar_state)">

                                <div class="btn btn-inverse"
                                      ng-click="clearStep()">
                                     <i class="fa fa-backward"></i></div>


                                <div class="btn btn-inverse" disabled>
                                   Fill in region, then click "Done"
                                </div>


                            </div>

                            <div class="btn-group pull-right"
                                 ng-show="compareState('rppaint', tool_bar_state)">

                                <div class="btn btn-success"
                                    ng-click="finishRegionPaint()">
                                    Done
                                </div>
                            </div>





                            <div class="btn-group"
                                ng-show="compareState('pldefine', tool_bar_state)">

                                 <div class="btn"
                                      ng-click="clearStep()">
                                     <i class="fa fa-backward"></i></div>


                                <div class="btn" disabled>
                                    Click to define perimeter points
                                </div>

                            </div>



                            <div class="btn-group"
                                ng-show="compareState('selectpbn', tool_bar_state)">


                                <nav>
                                    <ul>
                                        <li ng-repeat="(base_key, value) in step_options">
                                            <a href="#">
                                                <img class="optionimage" src="static/rev3/4/{{base_key+1}}.jpg"/>
                                            </a>

                                            <ul ng-show="value.options">
                                                <li ng-repeat="(sub_key, sub_value) in value.options">
                                                    <a href="#">
                                                        <img class="optionimage"
                                                             src="static/rev3/4/{{base_key+1}}/{{sub_key+1}}.jpg"/>
                                                    </a>


                                                    <ul ng-show="sub_value.options">
                                                        <li ng-repeat="(sub_sub_key, sub_sub_value) in sub_value.options">
                                                            <a href="#">
                                                                <img class="optionimage"
                                                                     src="static/rev3/4/{{base_key+1}}/{{sub_key+1}}/{{sub_sub_key+1}}.jpg"/>
                                                            </a>

                                                            <ul ng-show="sub_sub_value.options">
                                                                <li ng-repeat="(sub_sub_sub_key, sub_sub_sub_value) in sub_sub_value.options">
                                                                    <a href="#">
                                                                        <img class="optionimage"
                                                                             src="static/rev3/4/{{base_key+1}}/{{sub_key+1}}/{{sub_sub_key+1}}/{{sub_sub_sub_key+1}}.jpg"/>
                                                                    </a>

                                                                    <ul ng-show="sub_sub_sub_value.options">

                                                                        <li ng-repeat="(s_sub_sub_sub_key, s_sub_sub_sub_value) in sub_sub_sub_value.options">
                                                                            <a href="#">
                                                                                <img class="optionimage"
                                                                                     src="static/rev3/4/{{base_key+1}}/{{sub_key+1}}/{{sub_sub_key+1}}/{{sub_sub_sub_key+1}}/{{s_sub_sub_sub_key+1}}.jpg"/>
                                                                            </a>
                                                                        </li>

                                                                    </ul>

                                                                </li>
                                                            </ul>
                                                        </li>
                                                    </ul>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </nav>

                            </div>

                             <div class="btn-group pull-right"
                                ng-show="compareState('selectpbn', tool_bar_state)">

                                <button
                                        ng-click="nextStep()"
                                        class="btn btn-success">
                                        Next
                                </button>

                            </div>





                            <!--<div class="btn-group pull-right">-->
                                <!--<button type="button"-->
                                    <!--class="btn btn-default"-->
                                    <!--ng-click="acceptRegion()"-->
                                    <!--ng-show="hasTemporaryAnnotations()" >-->
                                    <!--Accept-->
                                <!--</button>-->
                            <!--</div>-->




                            <!-- Select -->

                            <div class="btn-group"
                                ng-show="compareState('select', tool_bar_state)">

                                <div class="btn" disabled>
                                    Selection:
                                </div>

                                <div class="btncontainer" ng-repeat="(key,value) in select_stack">
                                    <img class="btnimage" src="{{value.url}}"/>
                                </div>

                                <div class="btn"
                                     ng-click="clearStep()"
                                     ng-show="select_stack.length">
                                    <i class="fa fa-trash-o"></i>
                                </div>


                            </div>

                            <!--<div class="btn-group"-->
                                <!--ng-show="compareState('select', tool_bar_state)">-->

                                <!--<div class="btn btn-danger" ng-click="resetStep()">-->
                                <!--X-->
                                <!--</div>-->
                            <!--</div>-->


                            <!-- Review selections -->
                            <div class="btn-group"
                                ng-show="compareState('review', tool_bar_state)">

                                <div class="btn" disabled>
                                    Selection:
                                </div>

                                <div class="btncontainer" ng-repeat="(key,value) in select_stack">
                                    <img class="btnimage" src="{{value.url}}"/>
                                </div>

                                <div class="btn" ng-click="clearStep()">
                                <i class="fa fa-trash-o"></i>
                                </div>

                            </div>

                            <!--<div class="btn-group"-->
                                <!--ng-show="compareState('review', tool_bar_state)">-->


                                <!---->
                            <!--</div>-->

                            <!--<div class="btn-group pull-right">-->
                                <!--<button type="button" -->
                                    <!--class="btn btn-success" -->
                                    <!--ng-click="nextStep()"-->
                                    <!--ng-show="compareState('review', tool_bar_state)" >-->
                                    <!--Next -->
                                <!--</button>-->
                            <!--</div>-->





                            <!-- Default -->

                            <div class="btn-group pull-right"
                                ng-show="hasAnnotations()">

                                <button
                                        ng-click="nextStep()"
                                        class="btn btn-success">
                                        Next
                                </button>
                            </div>



                             <div class="btn-group"
                                ng-show="compareState('end', tool_bar_state)">

                                 <div class="btn btn-inverse" disabled>
                                   [todo: review of selections]
                                </div>

                            </div>


                            <div class="btn-group pull-right"
                                ng-show="compareState('end', tool_bar_state)">


                                <a
                                        ng-click="nextStep()"
                                        class="btn btn-success">
                                        Yes, annotation complete.
                                </a>
                            </div>


                            
                            <div class="btn-group">
                                <div class="btn"
                                     ng-show="hasTemporaryAnnotations()"
                                     ng-click="clearStep()">
                                <i class="fa fa-trash-o"></i>
                                </div>
                            </div>


                             <!-- point list -->

                             <div class="btn-group"
                                ng-show="compareState('rpreview', tool_bar_state)">

                                <div class="btn btn-inverse" disabled>
                                   Region is acceptable?
                                </div>

                            </div>

                            <!--  -->


                            <div class="advancedoptions">
                                    
                                <div class="optionitem" 
                                    ng-show="compareState('select', tool_bar_state)"
                                    ng-repeat="(key, value) in step_options">

                                        <div class="" href="#" ng-click="selectOption(key, value )">
                                            <img class="optionimage" src="static/rev3/{{step_base}}/{{key+1}}.jpg"/>
                                        </a>
                                </div>
                            </div>
                        </div>
                    </div>                    
                </div>
            </div>
        </div>


    </div>







    {% endraw %}

  {% else %}

    {% raw %}


      <div class="container-fluid">

          <div class="row-fluid">
              <div class="offset1 span10">
                  <iframe src="//player.vimeo.com/video/89748248" width="100%" height="750px" frameborder="0" we
                          bkitallowfullscreen mozallowfullscreen allowfullscreen></iframe> <p><a href="http://vimeo.com/89748248">ISIC Annotator - beta 3</a> from <a href="http://vimeo.com/wholeslide">Rich Stoner</a> on <a href="https://vimeo.com">Vimeo</a>.</p>
              </div>


          </div>



          <div class="row-fluid">
            <div class="offset1 span10">
              <h4>Pathology Image viewer for Whole Slide Images</h4>
              <p><a href="http://mskcc.digitalslidearchive.net">Pathology and Dermoscopic Lesion Viewer</a></p>

              <h4>Classify Derm Lesions by Example</h4>
              <p><a href="http://sideshowbob.psy.emory.edu/dan1000_livedev/DERM_annotator/web_dev/">Same as above on different host in case of any weird network issues</a></p>

              <h4>Alpha Version of Simple Annotator</h4>
              <p><a href="http://dermannotator.org">Shows online annotation capabilities</a></p>
            </div>

          </div>


      </div>

    {% endraw %}

  {% endif %}

{% endblock %}


{% block postjs %}


{% endblock %}